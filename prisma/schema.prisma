generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                            String            @id @default(uuid())
  email                         String            @unique
  name                          String
  password                      String?
  avatar                        String?
  googleId                      String?           @unique
  accessToken                   String?
  refreshToken                  String?
  createdAt                     DateTime          @default(now())
  updatedAt                     DateTime          @updatedAt
  grade                         String?
  preferences                   Json?
  schoolName                    String?
  fcmTokens                     String[]          @default([])
  isActive                      Boolean           @default(true)
  role                          UserRole          @default(USER)
  onboardingCompleted           Boolean           @default(false)
  onboardingAssessmentCompleted Boolean           @default(false)
  schoolId                      String?
  assessmentPopupShown          Boolean           @default(false)
  plan                          UserPlan          @default(FREE)
  attempts                      Attempt[]
  contents                      Content[]
  flashcardSets                 FlashcardSet[]
  leaderboard                   LeaderboardEntry?
  payments                      Payment[]
  quizzes                       Quiz[]
  reports                       Report[]
  streak                        Streak?
  studyPacks                    StudyPack[]
  subscription                  Subscription?
  summaryReactions              SummaryReaction[]
  tasks                         Task[]
  topicProgress                 TopicProgress[]
  userDocuments                 UserDocument[]
  quota                         UserQuota?
  school                        School?           @relation(fields: [schoolId], references: [id])

  @@map("users")
}

model UserQuota {
  id                              String   @id @default(uuid())
  userId                          String   @unique
  isPremium                       Boolean  @default(false)
  monthlyResetAt                  DateTime @default(now())
  createdAt                       DateTime @default(now())
  updatedAt                       DateTime @updatedAt
  monthlyFileUploadCount          Int      @default(0)
  totalFileStorageMB              Float    @default(0)
  monthlyConceptExplanationCount  Int      @default(0)
  monthlyFlashcardCount           Int      @default(0)
  monthlyQuizCount                Int      @default(0)
  monthlySmartCompanionCount      Int      @default(0)
  monthlySmartRecommendationCount Int      @default(0)
  monthlyStudyMaterialCount       Int      @default(0)
  monthlyWeakAreaAnalysisCount    Int      @default(0)
  user                            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("user_quotas")
}

model Quiz {
  id               String          @id @default(uuid())
  title            String
  topic            String
  difficulty       String          @default("medium")
  questions        Json
  userId           String
  sourceType       String?
  sourceFiles      String[]
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
  timeLimit        Int?
  contentId        String?         @unique
  quizType         QuizType        @default(STANDARD)
  tags             String[]        @default([])
  studyPackId      String?
  attempts         Attempt[]
  challengeQuizzes ChallengeQuiz[]
  challenges       Challenge[]
  content          Content?        @relation(fields: [contentId], references: [id])
  studyPack        StudyPack?      @relation(fields: [studyPackId], references: [id])
  user             User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  reports          Report[]

  @@index([studyPackId])
  @@index([userId])
  @@index([createdAt])
  @@map("quizzes")
}

model FlashcardSet {
  id          String     @id @default(uuid())
  title       String
  topic       String
  cards       Json
  userId      String
  sourceType  String?
  sourceFiles String[]
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  contentId   String?    @unique
  studyPackId String?
  attempts    Attempt[]
  content     Content?   @relation(fields: [contentId], references: [id])
  studyPack   StudyPack? @relation(fields: [studyPackId], references: [id])
  user        User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([studyPackId])
  @@index([userId])
  @@index([createdAt])
  @@map("flashcard_sets")
}

model Streak {
  id               String   @id @default(uuid())
  userId           String   @unique
  currentStreak    Int      @default(0)
  longestStreak    Int      @default(0)
  lastActivityDate DateTime @default(now())
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  level            Int      @default(1)
  totalXP          Int      @default(0)
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("streaks")
}

model LeaderboardEntry {
  id        String   @id @default(uuid())
  userId    String   @unique
  score     Int      @default(0)
  rank      Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([score])
  @@index([rank])
  @@map("leaderboard_entries")
}

model Challenge {
  id              String                @id @default(uuid())
  title           String
  description     String
  type            String
  target          Int
  reward          Int
  startDate       DateTime
  endDate         DateTime
  createdAt       DateTime              @default(now())
  updatedAt       DateTime              @updatedAt
  category        String?
  format          String                @default("STANDARD")
  quizId          String?
  rules           String?
  timeLimit       Int?
  maxParticipants Int?
  attempts        Attempt[]
  completions     ChallengeCompletion[]
  quizzes         ChallengeQuiz[]
  quiz            Quiz?                 @relation(fields: [quizId], references: [id])

  @@index([type])
  @@index([endDate])
  @@index([category])
  @@map("challenges")
}

model ChallengeCompletion {
  id               String    @id @default(uuid())
  challengeId      String
  userId           String
  progress         Int       @default(0)
  completed        Boolean   @default(false)
  completedAt      DateTime?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  currentQuizIndex Int       @default(0)
  finalScore       Int?
  percentile       Float?
  quizAttempts     Json?
  challenge        Challenge @relation(fields: [challengeId], references: [id], onDelete: Cascade)

  @@unique([challengeId, userId])
  @@index([userId])
  @@index([completed])
  @@map("challenge_completions")
}

model ChallengeQuiz {
  id          String    @id @default(uuid())
  challengeId String
  quizId      String
  order       Int
  createdAt   DateTime  @default(now())
  challenge   Challenge @relation(fields: [challengeId], references: [id], onDelete: Cascade)
  quiz        Quiz      @relation(fields: [quizId], references: [id], onDelete: Cascade)

  @@unique([challengeId, quizId])
  @@unique([challengeId, order])
  @@index([challengeId])
  @@index([quizId])
  @@map("challenge_quizzes")
}

model Attempt {
  id                String        @id @default(uuid())
  userId            String
  quizId            String?
  flashcardSetId    String?
  type              String
  score             Int?
  totalQuestions    Int?
  answers           Json?
  completedAt       DateTime      @default(now())
  createdAt         DateTime      @default(now())
  confidenceRatings Json?
  timeSpent         Int?
  challengeId       String?
  challenge         Challenge?    @relation(fields: [challengeId], references: [id])
  flashcardSet      FlashcardSet? @relation(fields: [flashcardSetId], references: [id], onDelete: Cascade)
  quiz              Quiz?         @relation(fields: [quizId], references: [id], onDelete: Cascade)
  user              User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([quizId])
  @@index([flashcardSetId])
  @@index([challengeId])
  @@index([completedAt])
  @@map("attempts")
}

model Recommendation {
  id        String   @id @default(uuid())
  userId    String
  topic     String
  reason    String
  priority  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  visible   Boolean  @default(true)

  @@unique([userId, topic])
  @@index([userId])
  @@index([priority])
  @@map("recommendations")
}

model Content {
  id               String          @id @default(uuid())
  title            String
  content          String
  topic            String
  userId           String
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
  flashcardSetId   String?
  learningGuide    Json?
  quizId           String?
  lastReadPosition Float           @default(0)
  description      String?
  studyPackId      String?
  studyPack        StudyPack?      @relation(fields: [studyPackId], references: [id])
  user             User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  flashcardSet     FlashcardSet?
  quiz             Quiz?
  reports          Report[]
  summary          Summary?
  topicProgress    TopicProgress[]

  @@index([studyPackId])
  @@index([userId])
  @@map("contents")
}

model Task {
  id        String     @id @default(uuid())
  userId    String
  result    Json?
  error     String?
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  status    TaskStatus @default(PENDING)
  type      TaskType
  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("tasks")
}

model TopicProgress {
  id             String         @id @default(uuid())
  userId         String
  topic          String
  retentionLevel RetentionLevel @default(LEARNING)
  strength       Int            @default(0)
  lastReviewedAt DateTime       @default(now())
  nextReviewAt   DateTime       @default(now())
  contentId      String?
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  content        Content?       @relation(fields: [contentId], references: [id])
  user           User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, topic])
  @@index([userId])
  @@index([nextReviewAt])
  @@index([retentionLevel])
  @@map("topic_progress")
}

model QuizRecommendation {
  id           String    @id @default(uuid())
  userId       String
  quizType     QuizType
  topic        String
  difficulty   String
  reason       String
  priority     String
  scheduledFor DateTime?
  completed    Boolean   @default(false)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  @@index([userId])
  @@index([completed])
  @@index([scheduledFor])
  @@index([priority])
  @@map("quiz_recommendations")
}

model WeakArea {
  id          String   @id @default(uuid())
  userId      String
  topic       String
  concept     String
  errorCount  Int      @default(1)
  lastErrorAt DateTime @default(now())
  resolved    Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([userId, topic, concept])
  @@index([userId])
  @@index([resolved])
  @@index([topic])
  @@map("weak_areas")
}

model StudySession {
  id           String    @id @default(uuid())
  userId       String
  type         String
  duration     Int
  itemsStudied Int
  performance  Float?
  startedAt    DateTime  @default(now())
  endedAt      DateTime?
  createdAt    DateTime  @default(now())

  @@index([userId])
  @@index([startedAt])
  @@index([type])
  @@map("study_sessions")
}

model School {
  id        String   @id @default(uuid())
  name      String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  users     User[]

  @@index([name])
  @@map("schools")
}

model Report {
  id        String   @id @default(uuid())
  userId    String
  contentId String?
  quizId    String?
  reason    String
  status    String   @default("PENDING")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  content   Content? @relation(fields: [contentId], references: [id], onDelete: Cascade)
  quiz      Quiz?    @relation(fields: [quizId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@map("reports")
}

model Document {
  id            String         @id @default(uuid())
  hash          String         @unique
  cloudinaryUrl String
  cloudinaryId  String
  googleFileUrl String?
  googleFileId  String?
  fileName      String
  mimeType      String
  sizeBytes     Int
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  userDocuments UserDocument[]

  @@index([hash])
  @@map("documents")
}

model UserDocument {
  id          String     @id @default(uuid())
  userId      String
  documentId  String
  displayName String
  uploadedAt  DateTime   @default(now())
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  studyPackId String?
  document    Document   @relation(fields: [documentId], references: [id], onDelete: Cascade)
  studyPack   StudyPack? @relation(fields: [studyPackId], references: [id])
  user        User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, documentId])
  @@index([studyPackId])
  @@index([userId])
  @@index([documentId])
  @@index([uploadedAt])
  @@map("user_documents")
}

model PlatformSettings {
  id                String   @id @default(uuid())
  allowRegistration Boolean  @default(true)
  maintenanceMode   Boolean  @default(false)
  supportEmail      String?
  aiPrompts         Json?
  updatedAt         DateTime @updatedAt

  @@map("platform_settings")
}

model StudyPack {
  id            String         @id @default(uuid())
  title         String
  description   String?
  coverImage    String?
  userId        String
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  contents      Content[]
  flashcardSets FlashcardSet[]
  quizzes       Quiz[]
  user          User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  userDocuments UserDocument[]

  @@index([userId])
  @@map("study_packs")
}

model SubscriptionPlan {
  id            String         @id @default(uuid())
  price         Float
  interval      String
  quotas        Json
  isActive      Boolean        @default(true)
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  name          PlanType
  subscriptions Subscription[]

  @@map("subscription_plans")
}

model Subscription {
  id                   String             @id @default(uuid())
  userId               String             @unique
  planId               String
  status               SubscriptionStatus @default(ACTIVE)
  currentPeriodEnd     DateTime
  cancelAtPeriodEnd    Boolean            @default(false)
  paystackCustomerCode String?
  createdAt            DateTime           @default(now())
  updatedAt            DateTime           @updatedAt
  pendingPlanId        String?
  payments             Payment[]
  plan                 SubscriptionPlan   @relation(fields: [planId], references: [id])
  user                 User               @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@index([currentPeriodEnd])
  @@map("subscriptions")
}

model Payment {
  id                String        @id @default(uuid())
  userId            String
  subscriptionId    String
  amount            Float
  paystackReference String        @unique
  status            PaymentStatus @default(PENDING)
  paidAt            DateTime?
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  failureReason     String?
  paymentChannel    String?
  paymentMethod     Json?
  subscription      Subscription  @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)
  user              User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([paystackReference])
  @@index([subscriptionId])
  @@index([paymentChannel])
  @@map("payments")
}

model Summary {
  id              String            @id @default(uuid())
  shortCode       String            @unique
  studyMaterialId String            @unique
  content         String
  viewCount       Int               @default(0)
  isPublic        Boolean           @default(true)
  failedAttempts  Int               @default(0)
  generatedAt     DateTime          @default(now())
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  studyMaterial   Content           @relation(fields: [studyMaterialId], references: [id], onDelete: Cascade)
  reactions       SummaryReaction[]
  views           SummaryView[]

  @@index([shortCode])
  @@index([studyMaterialId])
  @@index([isPublic])
  @@map("summaries")
}

model SummaryReaction {
  id        String   @id @default(uuid())
  summaryId String
  userId    String
  type      String
  createdAt DateTime @default(now())
  summary   Summary  @relation(fields: [summaryId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([summaryId, userId, type])
  @@index([summaryId])
  @@index([userId])
  @@map("summary_reactions")
}

model SummaryView {
  id        String   @id @default(uuid())
  summaryId String
  userId    String?
  ip        String?
  userAgent String?
  viewedAt  DateTime @default(now())
  summary   Summary  @relation(fields: [summaryId], references: [id], onDelete: Cascade)

  @@index([summaryId])
  @@index([userId])
  @@index([ip])
  @@map("summary_views")
}

enum UserRole {
  USER
  ADMIN
  SUPER_ADMIN
}

enum QuizType {
  STANDARD
  QUICK_CHECK
  TIMED_TEST
  SCENARIO_BASED
  CONFIDENCE_BASED
}

enum SubscriptionStatus {
  ACTIVE
  CANCELLED
  EXPIRED
  PENDING_PAYMENT
}

enum PaymentStatus {
  PENDING
  SUCCESS
  FAILED
}

enum ChallengeType {
  DAILY
  WEEKLY
  MONTHLY
  HOT
}

enum TaskStatus {
  PENDING
  COMPLETED
  FAILED
}

enum TaskType {
  ONBOARDING_ASSESSMENT
  CONTENT_GENERATION
}

enum RetentionLevel {
  LEARNING
  REINFORCEMENT
  RECALL
  MASTERY
}

enum UserPlan {
  FREE
  PREMIUM
}

enum PlanType {
  Free
  Premium
}
