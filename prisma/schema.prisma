generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  USER
  ADMIN
  SUPER_ADMIN
}

enum QuizType {
  STANDARD
  QUICK_CHECK
  TIMED_TEST
  SCENARIO_BASED
  CONFIDENCE_BASED
}

model User {
  id                            String   @id @default(uuid())
  email                         String   @unique
  name                          String
  password                      String?
  avatar                        String?
  googleId                      String?  @unique
  accessToken                   String?
  refreshToken                  String?
  schoolName                    String?
  schoolId                      String?
  school                        School?  @relation(fields: [schoolId], references: [id])
  grade                         String?
  role                          UserRole @default(USER)
  isActive                      Boolean  @default(true)
  onboardingCompleted           Boolean  @default(false)
  onboardingAssessmentCompleted Boolean  @default(false)
  assessmentPopupShown          Boolean  @default(false)
  preferences                   Json? // Store user preferences as JSON
  createdAt                     DateTime @default(now())
  updatedAt                     DateTime @updatedAt

  quizzes       Quiz[]
  flashcardSets FlashcardSet[]
  attempts      Attempt[]
  streak        Streak?
  leaderboard   LeaderboardEntry[]
  contents      Content[]
  highlights    Highlight[]
  tasks         Task[]
  topicProgress TopicProgress[]
  fcmTokens     String[]           @default([])
  reports       Report[]
  userDocuments UserDocument[]
  studyPacks    StudyPack[]

  @@map("users")
}

model Quiz {
  id          String   @id @default(uuid())
  title       String
  topic       String
  difficulty  String   @default("medium")
  quizType    QuizType @default(STANDARD)
  tags        String[] @default([])
  timeLimit   Int? // Time limit in seconds (for timed quizzes)
  questions   Json // Store questions array as JSON
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  sourceType  String? // "text" or "file"
  sourceFiles String[] // Array of file paths if generated from files
  contentId   String?  @unique
  content     Content? @relation(fields: [contentId], references: [id], onDelete: SetNull)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  attempts         Attempt[]
  challenges       Challenge[]
  challengeQuizzes ChallengeQuiz[]
  reports          Report[]
  studyPackId      String?
  studyPack        StudyPack?      @relation(fields: [studyPackId], references: [id], onDelete: SetNull)

  @@index([studyPackId])

  @@index([userId])
  @@index([createdAt])
  @@map("quizzes")
}

model FlashcardSet {
  id          String   @id @default(uuid())
  title       String
  topic       String
  cards       Json // Store flashcards array as JSON
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  sourceType  String? // "text", "file", or "topic"
  sourceFiles String[] // Array of file paths if generated from files
  contentId   String?  @unique
  content     Content? @relation(fields: [contentId], references: [id], onDelete: SetNull)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  attempts Attempt[]

  studyPackId String?
  studyPack   StudyPack? @relation(fields: [studyPackId], references: [id], onDelete: SetNull)

  @@index([studyPackId])

  @@index([userId])
  @@index([createdAt])
  @@map("flashcard_sets")
}

model Streak {
  id               String   @id @default(uuid())
  userId           String   @unique
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  currentStreak    Int      @default(0)
  longestStreak    Int      @default(0)
  lastActivityDate DateTime @default(now())
  totalXP          Int      @default(0)
  level            Int      @default(1)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@map("streaks")
}

model LeaderboardEntry {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  score     Int      @default(0)
  rank      Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId])
  @@index([score])
  @@index([rank])
  @@map("leaderboard_entries")
}

enum ChallengeType {
  DAILY
  WEEKLY
  MONTHLY
  HOT
}

model Challenge {
  id              String   @id @default(uuid())
  title           String
  description     String
  type            String // "daily", "weekly", "monthly", "hot"
  category        String? // More explicit categorization (e.g., "Daily Challenges", "Weekly Challenges")
  target          Int
  reward          Int
  startDate       DateTime
  endDate         DateTime
  rules           String?  @db.Text // Challenge-specific rules
  timeLimit       Int? // Overall time limit for the challenge in seconds
  maxParticipants Int? // Maximum number of participants allowed (10-100)
  format          String   @default("STANDARD") // "TIMED", "SCENARIO", "SPEED", "ACCURACY", "MIXED"
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  completions ChallengeCompletion[]
  quizzes     ChallengeQuiz[]
  attempts    Attempt[]

  // Legacy single quiz support (deprecated, use quizzes relation)
  quizId String?
  quiz   Quiz?   @relation(fields: [quizId], references: [id])

  @@index([type])
  @@index([endDate])
  @@index([category])
  @@map("challenges")
}

model ChallengeCompletion {
  id               String    @id @default(uuid())
  challengeId      String
  challenge        Challenge @relation(fields: [challengeId], references: [id], onDelete: Cascade)
  userId           String
  progress         Int       @default(0)
  completed        Boolean   @default(false)
  completedAt      DateTime?
  currentQuizIndex Int       @default(0) // Current quiz index in multi-quiz challenges
  quizAttempts     Json? // Array of quiz attempt results
  finalScore       Int? // Cumulative score across all quizzes
  percentile       Float? // User's percentile ranking (0-100)
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  @@unique([challengeId, userId])
  @@index([userId])
  @@index([completed])
  @@map("challenge_completions")
}

model ChallengeQuiz {
  id          String    @id @default(uuid())
  challengeId String
  challenge   Challenge @relation(fields: [challengeId], references: [id], onDelete: Cascade)
  quizId      String
  quiz        Quiz      @relation(fields: [quizId], references: [id], onDelete: Cascade)
  order       Int // Order of quiz in the challenge sequence (0-indexed)
  createdAt   DateTime  @default(now())

  @@unique([challengeId, quizId])
  @@unique([challengeId, order])
  @@index([challengeId])
  @@index([quizId])
  @@map("challenge_quizzes")
}

model Attempt {
  id                String   @id @default(uuid())
  userId            String
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  quizId            String?
  flashcardSetId    String?
  challengeId       String?
  type              String // "quiz", "flashcard", "challenge"
  score             Int?
  totalQuestions    Int?
  answers           Json? // Store user answers
  confidenceRatings Json? // Store confidence ratings for each answer
  timeSpent         Int? // Time spent in seconds
  completedAt       DateTime @default(now())
  createdAt         DateTime @default(now())

  quiz         Quiz?         @relation(fields: [quizId], references: [id], onDelete: Cascade)
  flashcardSet FlashcardSet? @relation(fields: [flashcardSetId], references: [id], onDelete: Cascade)
  challenge    Challenge?    @relation(fields: [challengeId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([quizId])
  @@index([flashcardSetId])
  @@index([challengeId])
  @@index([completedAt])
  @@map("attempts")
}

model Recommendation {
  id        String   @id @default(uuid())
  userId    String
  topic     String
  reason    String
  priority  String // "high", "medium", "low"
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, topic])
  @@index([userId])
  @@index([priority])
  @@map("recommendations")
}

model Content {
  id            String   @id @default(uuid())
  title         String
  content       String   @db.Text
  description   String?  // Short insightful description
  learningGuide Json? // Store structured learning guide
  topic         String
  userId        String
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  highlights       Highlight[]
  quiz             Quiz?
  flashcardSet     FlashcardSet?
  quizId           String?
  flashcardSetId   String?
  lastReadPosition Float           @default(0)
  topicProgress    TopicProgress[]
  reports          Report[]
  studyPackId      String?
  studyPack        StudyPack?      @relation(fields: [studyPackId], references: [id], onDelete: SetNull)

  @@index([studyPackId])

  @@index([userId])
  @@map("contents")
}

model Highlight {
  id           String   @id @default(uuid())
  contentId    String
  content      Content  @relation(fields: [contentId], references: [id], onDelete: Cascade)
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  text         String
  color        String   @default("yellow")
  startOffset  Int
  endOffset    Int
  note         String?
  sectionIndex Int?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([contentId])
  @@index([userId])
  @@map("highlights")
}

enum TaskStatus {
  PENDING
  COMPLETED
  FAILED
}

enum TaskType {
  ONBOARDING_ASSESSMENT
  CONTENT_GENERATION
}

model Task {
  id        String     @id @default(uuid())
  userId    String
  type      TaskType
  status    TaskStatus @default(PENDING)
  result    Json? // Store the result (e.g. contentId)
  error     String?
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("tasks")
}

enum RetentionLevel {
  LEARNING
  REINFORCEMENT
  RECALL
  MASTERY
}

model TopicProgress {
  id             String         @id @default(uuid())
  userId         String
  user           User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  topic          String
  retentionLevel RetentionLevel @default(LEARNING)
  strength       Int            @default(0) // 0-100
  lastReviewedAt DateTime       @default(now())
  nextReviewAt   DateTime       @default(now())
  contentId      String?
  content        Content?       @relation(fields: [contentId], references: [id], onDelete: SetNull)
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt

  @@unique([userId, topic])
  @@index([userId])
  @@index([nextReviewAt])
  @@index([retentionLevel])
  @@map("topic_progress")
}

model QuizRecommendation {
  id           String    @id @default(uuid())
  userId       String
  quizType     QuizType
  topic        String
  difficulty   String
  reason       String    @db.Text
  priority     String // "high", "medium", "low"
  scheduledFor DateTime?
  completed    Boolean   @default(false)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  @@index([userId])
  @@index([completed])
  @@index([scheduledFor])
  @@index([priority])
  @@map("quiz_recommendations")
}

model WeakArea {
  id          String   @id @default(uuid())
  userId      String
  topic       String
  concept     String // Specific concept within the topic
  errorCount  Int      @default(1)
  lastErrorAt DateTime @default(now())
  resolved    Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([userId, topic, concept])
  @@index([userId])
  @@index([resolved])
  @@index([topic])
  @@map("weak_areas")
}

model StudySession {
  id           String    @id @default(uuid())
  userId       String
  type         String // "quiz", "flashcard", "content_review"
  duration     Int // Duration in seconds
  itemsStudied Int // Number of items studied
  performance  Float? // Performance score (0-100)
  startedAt    DateTime  @default(now())
  endedAt      DateTime?
  createdAt    DateTime  @default(now())

  @@index([userId])
  @@index([startedAt])
  @@index([type])
  @@map("study_sessions")
}

model School {
  id        String   @id @default(uuid())
  name      String   @unique
  users     User[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([name])
  @@map("schools")
}

model Report {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  contentId String?
  content   Content? @relation(fields: [contentId], references: [id], onDelete: Cascade)
  quizId    String?
  quiz      Quiz?    @relation(fields: [quizId], references: [id], onDelete: Cascade)
  reason    String
  status    String   @default("PENDING") // PENDING, RESOLVED, IGNORED
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([status])
  @@map("reports")
}

model Document {
  id            String   @id @default(uuid())
  hash          String   @unique
  cloudinaryUrl String
  cloudinaryId  String
  googleFileUrl String?
  googleFileId  String?
  fileName      String
  mimeType      String
  sizeBytes     Int
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  userDocuments UserDocument[]

  @@index([hash])
  @@map("documents")
}

model UserDocument {
  id          String   @id @default(uuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  documentId  String
  document    Document @relation(fields: [documentId], references: [id], onDelete: Cascade)
  displayName String
  uploadedAt  DateTime @default(now())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  studyPackId String?
  studyPack   StudyPack? @relation(fields: [studyPackId], references: [id], onDelete: SetNull)

  @@index([studyPackId])

  @@unique([userId, documentId])
  @@index([userId])
  @@index([documentId])
  @@index([uploadedAt])
  @@map("user_documents")
}

model PlatformSettings {
  id                String   @id @default(uuid())
  allowRegistration Boolean  @default(true)
  maintenanceMode   Boolean  @default(false)
  supportEmail      String?
  aiPrompts         Json?
  updatedAt         DateTime @updatedAt

  @@map("platform_settings")
}

model StudyPack {
  id          String   @id @default(uuid())
  title       String
  description String?
  coverImage  String?
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  quizzes       Quiz[]
  flashcardSets FlashcardSet[]
  contents      Content[]
  userDocuments UserDocument[]

  @@index([userId])
  @@map("study_packs")
}
